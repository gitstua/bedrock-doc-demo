# Bedrock Doc Demo - Architecture Overview

## What is This Repository?

The **bedrock-doc-demo** is a complete demonstration of building a document-based question-answering system using Amazon Bedrock's Knowledge Base feature. It provides:

1. **Infrastructure as Code** to deploy AWS resources for document storage and knowledge base
2. **A Streamlit web application** that allows users to chat with documents using AI
3. **Helper scripts** for easy deployment and operation

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    User Interface                            │
│         (Streamlit App - app/app.py)                        │
│  ┌────────────────────────────────────────────────┐        │
│  │  Chat Interface with Sidebar Configuration     │        │
│  └────────────────────────────────────────────────┘        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      │ AWS API Calls (boto3)
                      │
┌─────────────────────▼───────────────────────────────────────┐
│              Amazon Bedrock Services                         │
│  ┌──────────────────────────────────────────────┐          │
│  │  Bedrock Agent Runtime                        │          │
│  │  - retrieve_and_generate API                  │          │
│  └──────────────────────────────────────────────┘          │
│  ┌──────────────────────────────────────────────┐          │
│  │  Knowledge Base                                │          │
│  │  - Vector embeddings (Titan Embed v2)         │          │
│  │  - Document retrieval                          │          │
│  │  - Response generation (Claude 3 Haiku)       │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌───────────────────┐    ┌──────────────────────┐
│  S3 Bucket        │    │  OpenSearch          │
│  - Source Docs    │    │  Serverless          │
│  - kb/ prefix     │    │  - Vector Store      │
└───────────────────┘    └──────────────────────┘
```

## Components

### 1. Streamlit Application (`app/`)

**Location**: `/app/app.py`

**Purpose**: Provides a web-based chat interface for querying documents stored in the Knowledge Base.

**Key Features**:
- Chat interface for natural language questions
- Sidebar configuration for AWS credentials and Knowledge Base settings
- Session management for conversation history
- Integration with Bedrock's `retrieve_and_generate` API

**Technologies**:
- Python 3.x
- Streamlit for the web UI
- boto3 for AWS API interactions

**Configuration**:
- Credentials can be provided via:
  - Sidebar UI (for testing)
  - `.streamlit/secrets.toml` file (for production)
  - Environment variables

### 2. Infrastructure as Code (`infra/cdk/`)

**Location**: `/infra/cdk/`

**Purpose**: AWS Cloud Development Kit (CDK) project to provision all required AWS infrastructure.

**What It Creates**:

1. **VPC with Private Networking**:
   - 2 Availability Zones
   - Private isolated subnets (no internet access)
   - VPC Endpoints for AWS services (Bedrock, S3, OpenSearch)
   - Security groups for endpoint access

2. **S3 Bucket**:
   - Stores source documents (PDFs, text files, etc.)
   - Configured with versioning and encryption
   - Documents stored under `kb/` prefix

3. **Bedrock Knowledge Base**:
   - Uses Amazon Titan Embed Text v2 for vector embeddings
   - Configured with OpenSearch Serverless as vector store
   - IAM role with appropriate permissions

4. **S3 Data Source**:
   - Links S3 bucket to Knowledge Base
   - Auto-syncs documents from `kb/` prefix
   - Uses Bedrock Data Automation for parsing

**Technologies**:
- AWS CDK (TypeScript)
- AWS CloudFormation (generated by CDK)

**Key Outputs**:
- Knowledge Base ID (needed for the Streamlit app)
- S3 Bucket Name (for uploading documents)
- VPC ID
- Data Source ID

### 3. Helper Scripts (`scripts/`)

**`deploy_infra.sh`**:
- Installs CDK dependencies (npm install)
- Deploys the CDK stack to AWS
- Uses standard AWS credential resolution

**`start.sh`**:
- Activates Python virtual environment
- Starts the Streamlit application
- Runs on local machine at http://localhost:8501

## Workflow: From Setup to Usage

### Phase 1: Infrastructure Deployment

1. **Prerequisites**:
   - AWS account with appropriate permissions
   - AWS credentials configured (via AWS CLI or environment variables)
   - Node.js installed (for CDK)
   - An existing OpenSearch Serverless collection

2. **Deploy Infrastructure**:
   ```bash
   ./scripts/deploy_infra.sh
   ```
   This creates:
   - VPC and networking components
   - S3 bucket for documents
   - Bedrock Knowledge Base
   - All required IAM roles and policies

3. **Note the Outputs**:
   - Save the Knowledge Base ID for app configuration
   - Save the S3 bucket name for document uploads

### Phase 2: Document Upload

1. Upload documents to the S3 bucket under the `kb/` prefix:
   ```bash
   aws s3 cp my-document.pdf s3://<bucket-name>/kb/
   ```

2. Trigger Knowledge Base synchronization (or wait for auto-sync):
   - Documents are parsed and embedded as vectors
   - Stored in OpenSearch Serverless collection

### Phase 3: Running the Application

1. **Setup Python Environment**:
   ```bash
   python -m venv app/venv
   source app/venv/bin/activate
   pip install -r app/requirements.txt
   ```

2. **Configure Secrets** (optional):
   ```bash
   mkdir -p app/.streamlit
   cp app/.streamlit/secrets.example app/.streamlit/secrets.toml
   # Edit secrets.toml with your credentials and Knowledge Base ID
   ```

3. **Start the App**:
   ```bash
   ./scripts/start.sh
   ```

4. **Use the Application**:
   - Open http://localhost:8501 in your browser
   - Configure AWS credentials in the sidebar (if not using secrets.toml)
   - Enter your Knowledge Base ID
   - Start asking questions about your documents!

### Phase 4: How It Works at Runtime

1. **User asks a question** in the Streamlit chat interface

2. **App calls Bedrock** using `retrieve_and_generate`:
   - Sends the user's question
   - Specifies the Knowledge Base ID
   - Specifies the model (Claude 3 Haiku by default)

3. **Bedrock processes the request**:
   - Converts the question to a vector embedding
   - Searches the OpenSearch collection for relevant document chunks
   - Retrieves the most relevant passages
   - Generates an answer using Claude 3 Haiku based on retrieved context

4. **Response is returned**:
   - Displayed in the chat interface
   - Added to conversation history

## Security and Networking

### Private Networking

The CDK stack creates a VPC with:
- **Private isolated subnets**: No direct internet access
- **VPC Endpoints**: Private connectivity to AWS services
  - Bedrock and Bedrock Runtime
  - Bedrock Agent and Agent Runtime
  - S3 (Gateway Endpoint)
  - OpenSearch Serverless

### Important Note on Knowledge Bases

Knowledge Bases are AWS-managed services and **do not run inside your VPC**. Private connectivity is achieved through:
1. VPC endpoints for client applications (like the Streamlit app when deployed to EC2)
2. Optional private access to OpenSearch Serverless collection

### IAM and Credentials

- **Knowledge Base Execution Role**: Grants Bedrock permissions to:
  - Read from S3 bucket
  - Access OpenSearch collection
  - Use embedding models

- **User Credentials**: Required for the Streamlit app to:
  - Call Bedrock Agent Runtime APIs
  - Must have permissions for `bedrock-agent-runtime:RetrieveAndGenerate`

## Key Technologies

| Component | Technology | Purpose |
|-----------|-----------|---------|
| Frontend | Streamlit | Web UI framework |
| Backend API | AWS Bedrock | AI/ML service for retrieval and generation |
| Embeddings | Amazon Titan Embed Text v2 | Convert text to vectors |
| LLM | Claude 3 Haiku | Generate answers from context |
| Vector Store | OpenSearch Serverless | Store and search document embeddings |
| Document Storage | Amazon S3 | Store source documents |
| IaC | AWS CDK (TypeScript) | Define and deploy infrastructure |
| Region | ap-southeast-2 (Sydney) | AWS region for all resources |

## Customization Options

### Change the LLM Model

Edit `app/.streamlit/secrets.toml`:
```toml
BEDROCK_MODEL_ARN = "arn:aws:bedrock:ap-southeast-2::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
```

### Change the Region

1. Update `infra/cdk/bin/app.ts` to change the CDK deployment region
2. Update `app/app.py` to change the boto3 client region
3. Update model ARNs to match the new region

### Add More Document Sources

The CDK stack can be extended to include additional data sources:
- Web crawlers
- Confluence
- SharePoint
- Salesforce

## Common Use Cases

1. **Internal Knowledge Base**: Company documentation, policies, procedures
2. **Customer Support**: Product manuals, troubleshooting guides
3. **Research Assistant**: Academic papers, research documents
4. **Legal/Compliance**: Regulatory documents, legal texts
5. **Technical Documentation**: API docs, architecture guides

## Cost Considerations

Running this solution incurs costs for:
- **S3 storage**: Based on document volume
- **OpenSearch Serverless**: Charged per OCU (OpenSearch Compute Units)
- **Bedrock API calls**: Per request and token usage
- **VPC resources**: Minimal for VPC endpoints
- **Data transfer**: Between services (usually minimal in same region)

## Limitations and Considerations

1. **OpenSearch Serverless must be created separately**: The CDK stack imports the collection ARN
2. **Network policy for OpenSearch**: Must be configured to allow Bedrock service role access
3. **Document format support**: Limited to formats supported by Bedrock Data Automation
4. **Regional availability**: Bedrock features vary by AWS region
5. **Knowledge Base sync**: Documents must be synced after upload to be searchable

## Troubleshooting

### "Knowledge Base not found" error
- Verify the Knowledge Base ID in configuration
- Ensure IAM credentials have access to the Knowledge Base

### "Access Denied" errors
- Check IAM permissions for Bedrock Agent Runtime
- Verify S3 bucket permissions for Knowledge Base role
- Check OpenSearch collection network and data access policies

### No relevant answers
- Ensure documents are uploaded to `kb/` prefix
- Trigger Knowledge Base sync after uploading documents
- Verify OpenSearch collection has indexed the documents

### VPC endpoint connection issues
- Ensure security groups allow HTTPS (port 443)
- Verify private DNS is enabled on VPC endpoints
- Check route tables for private subnets
